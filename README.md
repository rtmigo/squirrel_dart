# [squirrel](https://github.com/rtmigo/squirrel_dart)

`SquirrelStorage` accumulates structured log entries in a file-based local storage before sending them to the server.

## addEvent

```dart
import 'package:squirrel/squirrel.dart';

void main() {
    SquirrelStorage squirrel = await SquirrelStorage.create();

    // The argument to addEvent is arbitrary data. It is only 
    // important that it can be converted to JSON.

    await squirrel.root.addEvent('Text entry');
    await squirrel.root.addEvent({'type': 'info', 
                                  'text': 'Structured entry'});
    await squirrel.root.addEvent(['List entry', 1, 2, 3]);
}
```

## addContext

The entries can be grouped into "contexts".

```dart
import 'package:squirrel/squirrel.dart';

void main() {
    SquirrelStorage squirrel = await SquirrelStorage.create();

    final someContext = await squirrel.root.addContext(
        {'game': 'chess'});
    await someContext.addEvent({'move': 'E2-E4'});
    await someContext.addEvent({'move': 'E7-E5'});

    final otherContext = await squirrel.root.addContext(
        {'game': 'chess'});
    await otherContext.addEvent({'move': 'D2-D4'});
    await otherContext.addEvent({'move': 'D7-D5'});
}
```

When we create an event inside a context, the string ID of the corresponding context is appended to the event entry. The server may restore the tree structure along with the contexts if needed.

## Data format

### Events as JSON data

```dart
storage.root.addEvent({'a': 1, 'b': 2});
```

The data generated by such calls will be something like this:

```dart
{
    'I': 'U_sWAEJnR4epXu-TK0FCYA', // unique Slugid for each entry
    'T': 194942647293470,          // time in microseconds since epoch UTC
    'D': {'a': 1, 'b': 2},         // the data from argument
    'P': null                      // parent context; null for root
}
```

We will essentially send a list of such records converted to JSON to the server.

### Contexts as JSON data

```dart
var context = storage.root.addContext({'name': 'my context'});
context.addEvent('child event');
```

```dart
// the context is essentially an ordinary entry
{
    'I': 'ti8C-AKGQsq3rDjSuXe94w', // unique context id
    'T': 194942647293470,
    'D': {'name': 'parent context'},
    'P': null
},

// the child entry contains a reference to the parent context.
{
    'I': 'Fum-zBhASyO50rg3mtQcD',
    'T': 194942647223453,
    'D': 'child event',
    'P': 'ti8C-AKGQsq3rDjSuXe94w'  // link to the context id
}
```

## SquirrelSender

`SquirrelSender` automates sending logs to an abstract server when the number of records in the database exceeds a given limit. It binds to the `onModified` handler.

```dart
import 'package:squirrel/squirrel.dart';

Future<void> sendToServer(List<dynamic> chunk) await {
  // this function will receive data to be sent.
  // If the data cannot be sent (for example, due to connection errors),
  // the function should throw an exception.
}

void main()
   final sender = SquirrelSender(send: sendToServer);
   late SquirrelStorage squirrel;
   squirrel = await SquirrelStorage.create(
     onModified: () => sender.handleOnModified(squirrel));
   ...
   // use Squirrel as usual
}
```
