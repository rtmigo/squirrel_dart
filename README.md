# [squirrel](https://github.com/rtmigo/squirrel_dart)

`SquirrelStorage` accumulates structured log entries in a file-based local storage before sending them to the server.

## Adding entries

```dart
import 'package:squirrel/squirrel.dart';

void main() {
    final squirrel = await Squirrel.create();

    // The argument to addEvent is arbitrary data. It is only 
    // important that it can be converted to JSON.

    await squirrel.add('Text entry');

    await squirrel.add(['List entry', 1, 2, 3]);

    await squirrel.add({'type': 'info', 
                        'text': 'Structured entry',
                        'more': [1, 2, 3]});
}
```

## Adding child entries

Each entry can have a child entry.

```dart
import 'package:squirrel/squirrel.dart';

void main() {
    final squirrel = await Squirrel.create();

    final parentA = await squirrel.add({'game': 'chess'});
    await parentA.add({'move': 'E2-E4'});
    await parentA.add({'move': 'E7-E5'});

    final parentB = await squirrel.add({'game': 'chess'});
    await parentB.add({'move': 'D2-D4'});
    await parentB.add({'move': 'D7-D5'});
}
```

Child nodes can be nested. You can create a tree-like structure of any depth.

## Data format

### Entries as JSON data

```dart
storage.add({'mydata': 123});
```

The data generated by such calls will be something like this:

```dart
{
    'I': 'U_sWAEJnR4epXu-TK0FCYA', // unique Slugid for each entry
    'T': 194942647293470,          // time in microseconds since epoch UTC
    'D': {'mydata': 123},          // the data from argument
    'P': null                      // parent context; null for root
}
```

We will essentially send a list of such records converted to JSON to the server.

When adding child entries, the child data gets a link to the parent entry.

```dart
final parent = await squirrel.add({'mydata': 123});
await parent.add('child A');
await parent.add('child B');
```

```dart
// the parent is an ordinary entry
{
    'I': 'U_sWAEJnR4epXu-TK0FCYA', // note this id
    'T': 194942647293470,          
    'D': {'mydata': 123},          
    'P': null                      
},

// child entries contain a reference to the parent 
{
    'I': 'Fum-zBhASyO50rg3mtQcD',
    'T': 194942647223453,
    'D': 'child A',
    'P': 'U_sWAEJnR4epXu-TK0FCYA'  // link to the parent id
},

{
    'I': 'a8_YezW8T7e1jLxG7evy-A',
    'T': 194942647254428,
    'D': 'child B',
    'P': 'U_sWAEJnR4epXu-TK0FCYA'  // link to the parent id
},
```

## SquirrelSender

`SquirrelSender` automates sending logs to an abstract server when the number of records in the database exceeds a given limit (100 entries by default). It binds to the`onModified` handler.

```dart
import 'package:squirrel/squirrel.dart';

Future<void> sendToServer(List<dynamic> chunk) await {
  // this function will receive data to be sent.
  // If the data cannot be sent (for example, due to connection errors),
  // the function should throw an exception.
}

void main()
   final sender = SquirrelSender(send: sendToServer);
   late SquirrelStorage squirrel;
   squirrel = await Squirrel.create(
     onModified: () => sender.handleOnModified(squirrel));
   // ...
   // use Squirrel as usual
}
```
